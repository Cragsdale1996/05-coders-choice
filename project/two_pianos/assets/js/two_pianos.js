import { Socket } from "phoenix"
import { Piano }  from "./piano"
import { LobbyChannel } from "./lobby_channel"
import { UserChannel } from "./user_channel"

export class TwoPianos{
    
    constructor(){

        if(window.location.pathname === '/')          this.lobby_startup()
        else if(window.location.pathname === '/room') this.room_startup()

    }

    lobby_startup(){

        // Fetch embedded user_id from window / local storage (generated by backend)
        this.user_id = window.user_id
        console.log(`user_id: ${this.user_id}`)

        // Create User's piano (lobby)
        this.pianos        = {}
        this.pianos.mine   = new Piano(1)
        this.pianos.theirs = null

        // Set up socket
        this.socket = new Socket("/socket")
        this.socket.connect()

        // Init and join lobby and user channels
        this.channels = {}
        this.channels.lobby = LobbyChannel.setup_and_join(this.socket, this.user_id)
        this.channels.user = UserChannel.setup_and_join(this.socket, this.user_id)

    }

    room_startup(){

        this.user_id = localStorage.getItem("user_id")
        this.room_id = window.room_id
        console.log(`user_id: ${this.user_id}`)
        console.log(`room_id: ${this.room_id}`)

        // Create Pianos (room)
        this.pianos        = {}
        this.pianos.mine   = new Piano(1)
        this.pianos.theirs = new Piano(2)

        // Set up socket
        this.socket = new Socket("/socket")
        this.socket.connect()

        // Init and join room channel
        this.channels = {}
        this.channels.room = RoomChannel.setup_and_join(this.socket, this.user_id, this.room_id, this.pianos.theirs)

    }

}